<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../bower_components/polymerfire/polymerfire.html">
<link rel="import" href="theme.html">

<dom-module id="edit-method-page">
  <template>
    <style is="custom-style">
      :host {
      }
      .content {
        padding: 16px 50px 16px 50px;
      }
      .field {
        --paper-input-container-focus-color: var(--gkl-orange);
      }
      h1 {
        color: var(--gkl-gray-5);
        font-family: 'futura-pt', 'Helvetica Neue', Helvetica, Arial, sans-serif;
        font-size: 27px;
        font-weight: 700;
        text-align: left;
      }
      .indent {
        margin-left: 60px;
        width: 300px;
      }
      .method-name {
        --paper-input-container-color: var(--gkl-gray-4);
        --paper-input-container-focus-color: var(--gkl-gray-5);
      }
      paper-button.dialog-buttons {
        background-color: var(--gkl-orange);
        float: right;
        right: 20px;
      }
      paper-button.dialog-buttons#force-quit {
        background-color: var(--gkl-gray-1);
      }
      paper-button#publish {
        background-color: var(--gkl-blue);
        color: var(--gkl-gray-5);
        float: right;
        margin-bottom: 30px;
        margin-top: 30px;
      }
      paper-button#publish[disabled] {
        background-color: var(--gkl-gray-2);
        color: var(--gkl-gray-4);
      }
      paper-button.upload-buttons {
        background-color: var(--gkl-orange);
        margin-left: 0px;
      }
      paper-scroll-header-panel {
        --paper-scroll-header-panel-condensed-header: {
          background-color: var(--gkl-opaque-orange);
        };
        --paper-scroll-header-panel-full-header: {
          background-repeat: no-repeat !important;
          background-position: center !important;
          background-image: url("../assets/sandbox-card-front-background.png");
        };
        background-color: var(--background-color);
        bottom: 0;
        left: 0;
        position: absolute;
        right: 0;
        top: 0;
      }
      paper-toolbar {
        background-color: transparent;
        height: 165px; /* Full toolbar height (condensed is specified in the element tag) */
        overflow: visible;
      }
      #stages paper-checkbox {
        --paper-checkbox-checked-color: var(--gkl-orange);
        --paper-checkbox-checkmark-color: var(--gkl-gray-5);
        --paper-checkbox-unchecked-color: var(--gkl-gray-5);
        display: block;
        padding-bottom: 5px;
      }
    </style>
    <firebase-document
      id="document"
      app-name="methods"
      path="/methods/{{methodId}}"
      data="{{database}}">
    </firebase-document>
    <paper-scroll-header-panel class="header" condenses condensed-header-height="75" keep-condensed-header>
      <paper-toolbar>
        <!-- Top of toolbar (scrolls with condensed header, too) -->
        <paper-icon-button style="color: black" on-click='goBack' icon="close"></paper-icon-button>
        <!-- Method name -->
        <!-- 'bottom' class is Polymer-specific for bottom of full header -->
        <div class="bottom indent bottom-text" self-end>
          <paper-input class="method-name field" id="name" bind-value={{local.name}} placeholder="Type your method name here!" label="Method Name" always-float-label></paper-input>
        </div>
      </paper-toolbar>
      <div class="content">
        <h1>What is it</h1>
        <paper-textarea class="field" id="what" bind-value={{local.what}} label="What is it?" no-label-float></paper-textarea>
        <h1>Why we do it</h1>
        <paper-textarea class="field" id="why" bind-value={{local.why}} label="Why do we do it?" no-label-float></paper-textarea>
        <h1>How we do it</h1>
        <paper-textarea class="field" id="how" bind-value={{local.how}} label="How do we do it?" no-label-float></paper-textarea>
        <h1>Why it works</h1>
        <paper-textarea class="field" id="whyItWorks" bind-value={{local.whyItWorks}} label="Why does it work?" no-label-float></paper-textarea>
        <h1>When to use it</h1>
        <div id="stages">
          <paper-checkbox id="smart" on-click="checkStages">Get Smart</paper-checkbox>
          <paper-checkbox id="collab" on-click="checkStages">Collaborate to Solve</paper-checkbox>
          <paper-checkbox id="sprint" on-click="checkStages">Sprint to Make</paper-checkbox>
        </div>
        <h1>Best Practices</h1>
        <paper-textarea class="field" id="bestPractices" bind-value={{local.bestPractices}} label="Any best practices?" no-label-float></paper-textarea>
        <h1>Assets</h1>
        <paper-input class="field" id="slideDeck" bind-value={{method.slideDeck}} always-float-label label="If there's a keynote deck, include the dropbox link here."><div prefix>http://</div></paper-input>
        <paper-input class="field" id="logo" bind-value={{method.logo}} always-float-label label="Give a link to the logo here."><div prefix>http://</div></paper-input>
        <paper-input class="field" id="exemplar" bind-value={{method.exemplar}} always-float-label label="If there's a keynote deck, include the dropbox link here."><div prefix>http://</div></paper-input>
        <!-- TODO: upload buttons instead of just links -->
        <!-- <paper-button class="upload-buttons" raised>Upload an exemplar</paper-button> -->
        <!-- <paper-button class="upload-buttons" raised>Upload a logo</paper-button> -->
        <paper-dialog id="dialog" entry-animation="scale-up-animation" exit-animation="fade-out-animation" with-backdrop>
          <h2>Are You Sure?</h2>
          <p>You haven't saved your changes to this method. If you leave now, your changes will be lost! Do you still want to go back to the main page?</p>
          <paper-button class="dialog-buttons" on-click="keepEditing" raised>Keep editing</paper-button>
          <paper-button id="force-quit" class="dialog-buttons" on-click="forceQuit" raised>Close without saving</paper-button>
        </paper-dialog>
        <paper-button id="publish" on-click="publishMethod" disabled$="[[!unsavedChanges]]" raised>Publish</paper-button>
        <paper-toast id="toast" text="{{toastText}}"></paper-toast>
      </div>
    </paper-scroll-header-panel>
  </template>
  <script>
    Polymer({
      is: 'edit-method-page',
      properties: {
        database: {
          type: Object,
        },
        empty: {
          type: Object,
          readOnly: true,
          value: {'bestPractices': 'Coming Soon!', 'how': 'Coming Soon!','inProduction': false, 'slides': 'analog', 'stage': [], 'text': 'banana', 'what': 'Coming Soon!', 'why': 'Coming Soon!', 'whyItWorks': 'Coming Soon!'},
        },
        methodId: {
          type: String,
          value: 'new',
          observer: 'methodSetUp'
        },
        isNewMethod: {
          type: Boolean,
          value: true,
        },
        local: {
          type: Object,
        },
        toastText: {
          type: String,
        },
        unsavedChanges: {
          type: Boolean,
          value: false,
        }
      },
      observers: ['methodLoaded(database.name)', 'methodEdited(local.*)'], // Listen for when methods are loaded or changed
      checkStages: function() {
        this.local.stage = [];
        if (this.$.smart.checked) {
          this.local.stage.push('smart');
        }
        if (this.$.collab.checked) {
          this.local.stage.push('collab');
        }
        if (this.$.sprint.checked) {
          this.local.stage.push('sprint');
        }
        this.unsavedChanges = true; // local.* apparently doesn't track sub-array changes, so I manually flip the boolean here
      },
      forceQuit: function() {
        this.unsavedChanges = false;
        this.$.dialog.close();
        this.goBack();
      },
      getMethodId: function (methodName) {
        // Converts string to lower case ('#1 #Method_Name*' becomes '#1 #method_name*')
        // Replaces all non-alphanumeric characters with an underscore (note that underscores count as alphanumeric chars for some reason, so '#1 #method_name*' becomes '_1__method_name_')
        // Replace all sequences of one or more underscores with dashes (-) ('_1__method_name_' becomes '-1-method-name-)
        // Also removes leading/trailing dash ('-1-method-name-' becomes '1-method-name')
        methodName = methodName.toLowerCase().replace(/\W/g, '_').replace(/_+/g, '-').replace(/^-|-$/, '');
        return methodName;
      },
      goBack: function () {
        if (this.unsavedChanges) {
          this.$.dialog.open();
        } else {
          this.fire('go-back', {isNewMethod: this.isNewMethod});
        }
      },
      keepEditing: function() {
        this.$.dialog.close();
      },
      methodEdited: function(method) {
        if (!this.isNewMethod && method.path === 'local.name') {
          console.log("NAME CHANGE ALERT! NEED TO DELETE OLD METHOD")
          this.isNewMethod = true;
        }
        this.unsavedChanges = true;
      },
      methodIsComplete: function() {
        var name = true;
        var classification = true;
        this.toastText = "Please provide a ";
        if (typeof this.local.name === 'undefined' || this.local.name === '') {
          name = false;
          this.toastText = this.toastText.concat("name ");
        }
        if (this.local.stage.length === 0) {
          classification = false;
          if (!name) { this.toastText = this.toastText.concat("and "); }
          this.toastText = this.toastText.concat("classification ");
        }
        this.toastText = this.toastText.concat("for your method.");
        return name && classification;
      },
      methodLoaded: function(method) {
        if (typeof method !== 'undefined') {
          // Populate the input fields
          this.local = JSON.parse(JSON.stringify(this.database));
          this.$.bestPractices.value = this.local.bestPractices;
          this.$.how.value = this.local.how;
          this.$.name.value = this.local.name;
          this.$.what.value = this.local.what;
          this.$.why.value = this.local.why;
          this.$.logo.value = this.local.logo;
          this.$.exemplar.value = this.local.exemplar;
          this.$.slideDeck.value = this.local.slideDeck;
          this.$.whyItWorks.value = this.local.whyItWorks;
          this.$.smart.checked = (this.local.stage.indexOf("smart") !== -1);
          this.$.collab.checked = (this.local.stage.indexOf("collab") !== -1);
          this.$.sprint.checked = (this.local.stage.indexOf("sprint") !== -1);
          this.unsavedChanges = false;
        }
      },
      methodSetUp: function() {
        console.log("method set up");
        this.isNewMethod = (this.methodId === "new");
        if (this.isNewMethod) {
          // Clear input fields + initalize local object
          // This is necessary since the page doesn't reload between method edits
          this.$.bestPractices.value = '';
          this.$.how.value = '';
          this.$.name.value = '';
          this.$.what.value = '';
          this.$.why.value = '';
          this.$.logo.value = '';
          this.$.exemplar.value = '';
          this.$.slideDeck.value = '';
          this.$.whyItWorks.value = '';
          this.$.smart.checked = false;
          this.$.collab.checked = false;
          this.$.sprint.checked = false;
          // Initialize variables
          this.local = JSON.parse(JSON.stringify(this.empty));
          this.unsavedChanges = false;
        }
      },
      publishMethod: function() {
        if (this.methodIsComplete()) {
          if (this.isNewMethod) {
            this.local.id = this.getMethodId(this.local.name);
            this.local.exemplar = "firebasestorage.googleapis.com/v0/b/gkl-methods.appspot.com/o/exemplars%2Fexemplar.png?alt=media&token=4a8d5db1-8bf3-417a-aa07-8c8b3f3a2785";
            this.local.logo = "firebasestorage.googleapis.com/v0/b/gkl-methods.appspot.com/o/logos%2Flogo.png?alt=media&token=0b7849a6-55e9-4320-a395-7ec3f347a0a4";
            this.methodId = this.local.id;
          }
          this.database = JSON.parse(JSON.stringify(this.local));
          this.fire('method-clicked', {name: this.methodId});
        } else {
          this.$.toast.open();
        }
      },
    });
  </script>
</dom-module>